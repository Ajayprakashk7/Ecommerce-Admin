import ye,{useState as Ce,useCallback as he,forwardRef as Ie}from"react";import we from"next/image";import{getTransformations as Ue}from"@cloudinary-util/util";import{transformationPlugins as Ee}from"@cloudinary-util/url-loader";async function R(e){let{src:s}=e;try{await new Promise((d,o)=>{fetch(s).then(t=>{if(!t.ok){o(t);return}d(t)})})}catch(d){return d.status===423?await R(e):!1}return!0}import{constructCloudinaryUrl as fe}from"@cloudinary-util/url-loader";import ue from"next/package.json";var ee={name:"next-cloudinary",version:"4.25.0",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup src/index.ts --dts",dev:"tsup src/index.ts --watch --dts",prepublishOnly:"cp ../README.md . && yarn build",postpublish:"rm ./README.md",test:"jest","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" yarn build && cd tests/nextjs-app && yarn build'},dependencies:{"@cloudinary-util/url-loader":"^3.10.0","@cloudinary-util/util":"^2.2.1"},devDependencies:{"@babel/core":"^7.19.6","@babel/preset-env":"^7.19.4","@types/jest":"^29.2.0","@types/react":"^18.0.28","@types/react-dom":"^18.0.11","babel-jest":"^29.2.2",dotenv:"^16.0.3",jest:"^29.2.2","jest-environment-jsdom":"^29.2.2",mkdirp:"^3.0.1","ts-jest":"^29.0.3",tsup:"^7.2.0",typescript:"^5.2.2"},peerDependencies:{next:"^12 || ^13",react:"^17 || ^18"}};var te="V",oe=ee.version,re=ue.version;function h(e,s,d){var t,i;let o=(i=(t=s==null?void 0:s.cloud)==null?void 0:t.cloudName)!=null?i:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;return fe({options:e,config:Object.assign({cloud:{cloudName:o}},s),analytics:Object.assign({sdkCode:te,sdkSemver:oe,techVersion:re,feature:""},d)})}function z({loaderOptions:e,imageProps:s,cldOptions:d,cldConfig:o={}}){let t={...s,...d};if(t.width=typeof t.width=="string"?parseInt(t.width):t.width,t.height=typeof t.height=="string"?parseInt(t.height):t.height,typeof(e==null?void 0:e.width)=="number"&&typeof t.width=="number"&&e.width!==t.width){let i=e.width/t.width;t.widthResize=e.width,typeof t.height=="number"&&(t.heightResize=Math.round(t.height*i))}else typeof(e==null?void 0:e.width)=="number"&&typeof(t==null?void 0:t.width)!="number"&&(t.width=e.width,t.widthResize=e.width);return h(t,o)}var ne=Ie((e,s)=>{let d=!1,o=["deliveryType","preserveTransformations"];Ee.forEach(({props:n=[]})=>{n.forEach(l=>{if(o.includes(l))throw new Error(`Option ${l} already exists!`);o.push(l)})});let t={alt:e.alt,src:e.src};Object.keys(e).filter(n=>!o.includes(n)).forEach(n=>t[n]=e[n]);let i=Object.keys(t).map(n=>`${n}:${t[n]}`).join(";"),[g,C]=Ce(i),c={};if(o.forEach(n=>{e[n]&&(c[n]=e[n]||void 0)}),e.preserveTransformations)try{let n=Ue(e.src).map(l=>l.join(","));c.rawTransformations=[...n.flat(),...e.rawTransformations||[]]}catch(n){console.warn(`Failed to preserve transformations: ${n.message}`)}let m=process.env.__NEXT_IMAGE_OPTS||{};(e.unoptimized===!0||(m==null?void 0:m.unoptimized)===!0)&&(t.src=h({...c,width:t.width,height:t.height,src:t.src,format:"default",quality:"default"},e.config));async function r(n){let l=!0;if(d)return;if(d=!0,typeof e.onError=="function"){let I=e.onError(n);typeof I=="boolean"&&I===!1&&(l=!1)}else typeof e.onError=="boolean"&&e.onError===!1&&(l=!1);if(l===!1)return;let _=n.target;await R({src:_.src})&&C(`${i};${Date.now()}`)}let x=he(r,[R,i]),f=we;return"default"in f&&(f=f.default),ye.createElement(f,{key:g,...t,loader:n=>z({loaderOptions:n,imageProps:t,cldOptions:c,cldConfig:e.config}),onError:x,ref:s})});ne.displayName="CldImage";var ie=ne;import w from"react";import Pe from"next/head";var Oe="summary_large_image",xe=({excludeTags:e=[],twitterTitle:s,keys:d={},...o})=>{let{alt:t}=o,i={...o,crop:o.crop||"fill",gravity:o.gravity||"center",height:o.height||1254,src:o.src,width:o.width||2400,widthResize:o.width||1200},g=typeof i.width=="string"?parseInt(i.width):i.width,C=typeof i.height=="string"?parseInt(i.height):i.height;typeof C=="number"&&typeof g=="number"&&(C=1200/g*C),g=1200;let c=h({...i,format:o.format||"jpg"}),m=h({...i,format:o.format||"webp"}),r={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...d};return w.createElement(Pe,null,w.createElement("meta",{key:r["og:image"],property:"og:image",content:c}),w.createElement("meta",{key:r["og:image:secure_url"],property:"og:image:secure_url",content:c}),w.createElement("meta",{key:r["og:image:width"],property:"og:image:width",content:`${g}`}),w.createElement("meta",{key:r["og:image:height"],property:"og:image:height",content:`${C}`}),t&&w.createElement("meta",{key:r["og:image:alt"],property:"og:image:alt",content:t}),!e.includes("twitter:title")&&w.createElement("meta",{key:r["twitter:title"],property:"twitter:title",content:s||" "}),w.createElement("meta",{key:r["twitter:card"],property:"twitter:card",content:Oe}),w.createElement("meta",{key:r["twitter:image"],property:"twitter:image",content:m}))},ae=xe;import $ from"react";import q,{useState as K,useEffect as le,useRef as se}from"react";import _e from"next/script";function de(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var be=["success","display-changed"],ve={abort:"onAbort","batch-cancelled":"onBatchCancelled","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},Le=({children:e,onClose:s,onError:d,onOpen:o,onUpload:t,options:i,signatureEndpoint:g,uploadPreset:C,...c})=>{let m=se(),r=se(),x=!!g,[f,n]=K(void 0),[l,_]=K(void 0),[L,I]=K(!0),U={cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,uploadPreset:C||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,...i};x&&(U.uploadSignature=T,U.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),le(()=>{if(typeof l=="undefined")return;let y=l.event==="success",P=l.event==="display-changed"&&l.info==="hidden";y&&typeof t=="function"&&t(l,r.current),P&&typeof s=="function"&&s(r.current)},[l]),le(()=>{f&&typeof d=="function"&&d(f,r.current)},[f]);function b(){I(!1),m.current||(m.current=window.cloudinary),de(()=>{r.current||(r.current=D())})}function T(y,P){if(typeof g=="undefined")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(g,{method:"POST",body:JSON.stringify({paramsToSign:P})}).then(p=>p.json()).then(({signature:p})=>{y(p)})}function u(y){r.current||(r.current=D()),typeof(r==null?void 0:r.current[y])=="function"&&r.current[y]()}function S(){u("close")}function A(){u("destroy")}function E(){u("hide")}function N(){u("isDestroyed")}function W(){u("isMinimized")}function M(){u("isShowing")}function B(){u("minimize")}function k(){u("open"),typeof o=="function"&&o(r.current)}function G(){u("show")}function V(){u("update")}let F={close:S,destroy:A,hide:E,isDestroyed:N,isMinimized:W,isShowing:M,minimize:B,open:k,show:G,update:V};function D(){var y;return(y=m.current)==null?void 0:y.createUploadWidget(U,(P,p)=>{if(typeof P=="string"&&n(P),typeof(p==null?void 0:p.event)=="string"){be.includes(p==null?void 0:p.event)&&_(p);let a=ve[p.event];if(typeof a=="string"&&typeof c[a]=="function"&&typeof c[a]){let O=c[a];O(p,{widget:r.current,...F})}}})}return q.createElement(q.Fragment,null,typeof e=="function"&&e({cloudinary:m.current,widget:r.current,results:l,error:f,isLoading:L,...F}),q.createElement(_e,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://widget.cloudinary.com/v2.0/global/all.js",onLoad:b,onError:y=>console.error(`Failed to load Cloudinary Upload Widget: ${y.message}`)}))},H=Le;var Te=({className:e,children:s,onClick:d,onError:o,onOpen:t,onUpload:i,onAbort:g,onBatchCancelled:C,onClose:c,onDisplayChanged:m,onPublicId:r,onQueuesEnd:x,onQueuesStart:f,onRetry:n,onShowCompleted:l,onSourceChanged:_,onSuccess:L,onTags:I,onUploadAdded:U,options:b,signatureEndpoint:T,uploadPreset:u,...S})=>$.createElement($.Fragment,null,$.createElement(H,{onError:o,onOpen:t,onUpload:i,onAbort:g,onBatchCancelled:C,onClose:c,onDisplayChanged:m,onPublicId:r,onQueuesEnd:x,onQueuesStart:f,onRetry:n,onShowCompleted:l,onSourceChanged:_,onSuccess:L,onTags:I,onUploadAdded:U,options:b,signatureEndpoint:T,uploadPreset:u},({open:A,isLoading:E})=>{function N(W){W.preventDefault(),A(),typeof d=="function"&&d(W)}return $.createElement("button",{...S,className:e||"",onClick:N,disabled:E},s||"Upload")})),ce=Te;import v,{useRef as Q}from"react";import Ae from"next/script";import Ne from"next/head";import{parseUrl as We}from"@cloudinary-util/util";var pe=[],Ge=e=>{let{autoPlay:s="never",className:d,colors:o,controls:t=!0,fontFace:i,height:g,id:C,logo:c=!0,loop:m=!1,muted:r=!1,onDataLoad:x,onError:f,onMetadataLoad:n,onPause:l,onPlay:_,onEnded:L,src:I,sourceTypes:U,transformation:b,version:T="1.9.16",quality:u="auto",width:S}=e,A=Array.isArray(b)?b:[b],E=I||"";if(typeof e.version=="string"&&console.warn("The version prop will no longer be supported in future versions due to the unreliability of coordinating assets"),E.startsWith("http"))try{let a=We(I);typeof(a==null?void 0:a.publicId)=="string"&&(E=a==null?void 0:a.publicId)}catch(a){}A.unshift({quality:u});let N=Q(),W=Q(),M=e.videoRef||W,B=Q(),k=e.playerRef||B,G=C||`player-${E.replace("/","-")}`,V="cld-video-player cld-fluid";d&&(V=`${V} ${d}`),pe.filter(a=>a===G).length>1?console.warn(`Multiple instances of the same video detected on the
     page which may cause some features to not work. 
    Try adding a unique id to each player.`):pe.push(G);let D={error:f,loadeddata:x,loadedmetadata:n,pause:l,play:_,ended:L};function y(a){let O=D[a.type];typeof O=="function"&&O(p())}function P(){if("cloudinary"in window){N.current=window.cloudinary;let a={};typeof c=="boolean"?a.showLogo=c:typeof c=="object"&&(a={...a,showLogo:!0,logoImageUrl:c.imageUrl,logoOnclickUrl:c.onClickUrl});let O={autoplayMode:s,cloud_name:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,controls:t,fontFace:i||"",loop:m,muted:r,publicId:E,secure:!0,transformation:A,...a};Array.isArray(U)&&(O.sourceTypes=U),typeof o=="object"&&(O.colors=o),k.current=N.current.videoPlayer(M.current,O),Object.keys(D).forEach(J=>{var Z;typeof D[J]=="function"&&((Z=k.current)==null||Z.on(J,y))})}}function p(){return{player:k.current,video:M.current}}return v.createElement(v.Fragment,null,v.createElement(Ne,null,v.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${T}/dist/cld-video-player.min.css`,rel:"stylesheet"})),v.createElement("div",{style:{width:"100%",aspectRatio:`${e.width} / ${e.height}`}},v.createElement("video",{ref:M,id:G,className:V,width:S,height:g}),v.createElement(Ae,{id:`cloudinary-videoplayer-${G}`,src:`https://unpkg.com/cloudinary-video-player@${T}/dist/cld-video-player.min.js`,onLoad:P,onError:a=>console.error(`Failed to load Cloudinary Video Player: ${a.message}`)})))},ge=Ge;function De(e){return h({...e,crop:e.crop||"fill",format:e.format||"jpg",gravity:e.gravity||"center",height:e.height||1254,width:e.width||2400,widthResize:e.width||1200})}export{ie as CldImage,ae as CldOgImage,ce as CldUploadButton,H as CldUploadWidget,ge as CldVideoPlayer,z as cloudinaryLoader,h as getCldImageUrl,De as getCldOgImageUrl};
//# sourceMappingURL=index.mjs.map